<div><div># webservice-api</div><div><br></div><div>## 技术栈</div><div>- TS + Nodejs</div><div>- koa + koa-router + graphql + log4js + note-fetch + cfork</div><div><br></div><div>## 功能</div><div>- 天网日志</div><div>- 路由配置</div><div>- 短路径 + 拦截器</div><div>- Graphql</div><div>- 接口签名</div><div><br></div><div>## 目录结构</div><div>```</div><div>webservice-api</div><div>├─build&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;编译时需要外的一些操作</div><div>├─dist&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 编译输出目录</div><div>├─files&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;一些运行时产生的临时数据，目前主要是dev时的日志</div><div>├─serve&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;服务端代码</div><div>│&nbsp; &nbsp;├─config&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 程序运行的一些配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─conf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 程序配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─comm&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 通用的代码</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─end&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;运行环境</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─fetch&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node-fetch 配置目录，提供全局的接口请求方式</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;├─lib</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;├─fro.ts&nbsp; &nbsp; &nbsp; &nbsp; 后端 wx.17u.cn/frontstage 的短路径和拦截器配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;├─nin1.ts&nbsp; &nbsp; &nbsp; &nbsp;.net中间层访问配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;├─supplier.ts&nbsp; &nbsp;供应商访问拦截器配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;│&nbsp; &nbsp;├─ts.ts&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;后端 ticketsearch 拦截器</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─gql&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;graphql配置目录</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─log4js&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 日志配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─router&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 路由配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─sign&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 数字签名配置</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─index.ts&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 将上面的配置整体输出</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─import.ts&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;仅需要导入就可以的配置 如 /serve/config/lib/fro.ts</div><div>│&nbsp; &nbsp;├─api&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;业务代码</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─monitor&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;用于健康检测监控 /webservice-api/data/monitor/</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─railway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12306相关 /webservice-api/data/railway/</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─train&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;车次，比如车次列表、车次详情&nbsp; /webservice-api/data/train/</div><div>│&nbsp; &nbsp;│&nbsp; &nbsp;├─test&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 一些测试代码 /webservice-api/data/test/</div><div>│&nbsp; &nbsp;├─gql&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;graphql路由实现 /webservice-api/data/gql/</div><div>├─www&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;静态目录</div><div>├─.eslintrc.js&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eslint配置</div><div>├─.gitignore&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; git提交过滤文件配置</div><div>├─.prettierrc.js&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 格式化配置</div><div>├─package.json&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 包设置</div><div><br></div><div>```</div><div><br></div><div>## 功能函数 rimjs&nbsp;&nbsp;</div><div>[http://train.17usoft.net/trainh5book/vuetplv3ts/book/rimjs/](http://train.17usoft.net/trainh5book/vuetplv3ts/book/rimjs/)</div><div><br></div><div>## 通用数据体定义</div><div><br></div><div>`CommArg` 通用路由交互参数</div><div>- **timeStamp**: number = 0&nbsp; &nbsp;当前时间，毫秒数</div><div>- **memberId**: string = ''&nbsp; &nbsp;会员id</div><div>- **openId**: string = ''&nbsp; &nbsp; &nbsp;微信或者qq的openid</div><div>- **platId**: number = 0&nbsp; &nbsp; &nbsp; 渠道id</div><div>- **unionId**: string = ''&nbsp; &nbsp; 微信特有</div><div><br></div><div>`ExportBody` 通用的导出数据体</div><div>- **status**: number = 200&nbsp; 输出状态值，同http状态</div><div>- **code**: string = 'ok'&nbsp; ok表示成功，其他的都是错误</div><div>- **data**?: any&nbsp; 输出数据</div><div>- **msg**: string = '' 输出信息提示</div><div>- **ext**?: any&nbsp; &nbsp;一些扩展的信息</div><div>- **errs**?: { [prot: string]: { code: string; msg: any } }&nbsp; 一些特殊的错误信息（gql用）</div><div>- **getData**(?key:string) 安全的获取data中的数据，如果不存在，返回null</div><div><br></div><div>`KoaExportBody` extends `ExportBody`</div><div>- 继承`ExportBody` 用户Koa路由输出</div><div>- **runTime**: number = 0&nbsp; &nbsp;接口运行耗时</div><div>- **serveTime**: string&nbsp; &nbsp; &nbsp;服务器时间</div><div>- **assign**(res:ExportBody)&nbsp; &nbsp; 将 `ExportBody`上的数据全部导入自己</div><div><br></div><div>```ts</div><div>let eData = new ExportBody()</div><div>eData.data = { a: { b: 1 } }</div><div>console.log(</div><div>&nbsp; &nbsp; eData.getData(), // {a:{b:1}}</div><div>&nbsp; &nbsp; eData.getData('a'), // {b:1}</div><div>&nbsp; &nbsp; eData.getData('a.b'), // 1</div><div>&nbsp; &nbsp; eData.getData('c'), // null</div><div>&nbsp; &nbsp; eData.getData('a.c') // null</div><div>)</div><div><br></div><div>// KoaExportBody</div><div>let ept = new KoaExportBody()</div><div>ept.assign(eData)</div><div>console.log(</div><div>&nbsp; &nbsp; ept.data, // {a:{b:1}}</div><div>&nbsp; &nbsp; ept.data == eData.data // false</div><div>)</div><div><br></div><div>```</div><div><br></div><div>## 天网日志</div><div>- logCfork&nbsp; cfork日志记录，一般不用关注 【天网一级目录选择&nbsp; cfork】</div><div>- logger&nbsp; &nbsp; 普通日志记录&nbsp; 【天网一级目录选择&nbsp; log】</div><div>- logServe&nbsp; route接受到输出的日志记录（接受请求自动触发埋点） 【天网一级目录选择&nbsp; serve】</div><div>- logFetch&nbsp; 调用后端接口日志记录（调用netFetch自动触发埋点） 【天网一级目录选择&nbsp; fetch】</div><div>&nbsp;&nbsp;</div><div>```ts</div><div>import { logger } from '@bs'</div><div><br></div><div>// 记录日志</div><div>logger.warn('[reTrainList] [' + (new Date().getTime() - t1) + '] ' + JSON.stringify(para))</div><div>```</div><div><br></div><div>## 路由配置&nbsp;&nbsp;</div><div><br></div><div>### 访问方式参数</div><div>- querystring&nbsp; &nbsp;方式</div><div>- para&nbsp; 接口自定义的访问参数，值由JSON.stringify转换</div><div>- commArg:CommArg 通用参数</div><div>&nbsp;&nbsp;</div><div><br></div><div>### 路由控制器</div><div>```ts</div><div>// 路由控制器导入</div><div>import { RouteContral, netFetch } from '@bs'</div><div>// 输出</div><div>let railwayContral = new RouteContral('railway')</div><div><br></div><div>// 访问路径 /webservice-api/data/railway/pullListData</div><div>railwayContral.on(</div><div>&nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; path: 'pullListData',</div><div>&nbsp; &nbsp; &nbsp; &nbsp; method: 'post'</div><div>&nbsp; &nbsp; },</div><div>&nbsp; &nbsp; async function ({ allPara: para, export: ept }) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // #para 表示 参数放置在 url上</div><div>&nbsp; &nbsp; &nbsp; &nbsp; let res = await netFetch('post.fro:multiple/externalOrderPullData?#para', para)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // 后端拿到的数据作用在接口返回上</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ept.assign(res)</div><div>&nbsp; &nbsp; }</div><div>)</div><div><br></div><div>```</div><div>`new RouteContral(path:string, options?: {method?:string;useValid?:boolean;useSign:boolean})`</div><div>- **path** 设置路由的前置路径，可以为空，不建议为空，会导致路由混乱</div><div>- **method**=get 方法 'get' | 'post' | 'put' | 'all'</div><div>- **useValid**=false 接口请求验证有效时间</div><div>- **useSign**=true 接口验证签名</div><div>- **useAuth**=true 接口验证 用户身份信息</div><div><br></div><div>`routeContral.on(option: IRequestOption | IExecFn | string, exec?: IExecFn)`</div><div>- **option**:string 表示路由的响应路径</div><div>- **option**:{path:string;method?:string;useValid?:boolean;useSign:boolean}</div><div>&nbsp; - **path** 表示路由的响应路径</div><div>&nbsp; - **method** 方法 'get' | 'post' | 'put' | 'all'</div><div>&nbsp; - **useValid** 接口请求验证有效时间</div><div>&nbsp; - **useSign** 接口验证签名</div><div>&nbsp; - **useAuth**=true 接口验证 用户身份信息</div><div>- **option**:({params:any;param:any;export:KoaExportBody;ctx:KoaContext;para:any;commArg:CommArg;*allPara*:para&amp;CommArg;next:KoaNext}) 路由执行函数</div><div>&nbsp; - **params** 同ctx.params</div><div>&nbsp; - **param** ctx.query || ctx.body</div><div>&nbsp; - **export** KoaExportBody</div><div>&nbsp; - **ctx** koa的context</div><div>&nbsp; - **para** param.para json格式化对象</div><div>&nbsp; - **commArg** CommArg param.commArg 格式化对象</div><div>&nbsp; - **allPara** para&amp;CommArg</div><div>&nbsp; - **next** koa的next函数</div><div><br></div><div>&gt; method、useValid、useSign 取值为 `routeContral.on` -&gt; `RouteContral` -&gt; 默认值(get、false、true)</div><div><br></div><div><br></div><div>## 短路径 + 拦截器 （node-fetch）</div><div><br></div><div>### 配置&nbsp;&nbsp;</div><div>/serve/lib/fetch 里面配置，并在index.ts 引入</div><div><br></div><div>### 访问&nbsp;&nbsp;</div><div>统一通过 netFetch 来访问</div><div><br></div><div>### 拦截器配置和使用</div><div>- 配置实例：/serve/lib/fetch/</div><div>- 实例：/serve/api/railway/</div><div><br></div><div>`addNetFetchPath(path: string, pathObj: INetFetchPaths`</div><div>- **path** 配置的短路径</div><div>- **pathObj** 短路径对应的配置 INetFetchPaths</div><div>&nbsp; - **path**&nbsp; &nbsp; 短路径对应的路径配置</div><div>&nbsp; - **reqFn**(opt:FetchOption, option:IFetchRequestInit)</div><div>&nbsp; &nbsp; - **opt**&nbsp; &nbsp;请求netFetch是的一些特殊参数</div><div>&nbsp; &nbsp; &nbsp; - **fUrl**&nbsp; &nbsp; &nbsp; &nbsp; 当前请求路径</div><div>&nbsp; &nbsp; &nbsp; - **orginUrl**&nbsp; &nbsp; 原始的短路径地址</div><div>&nbsp; &nbsp; &nbsp; - **para**&nbsp; &nbsp; &nbsp; &nbsp; 传入的参数</div><div>&nbsp; &nbsp; - **option**&nbsp; &nbsp; &nbsp; &nbsp; note-fetch使用的options</div><div>&nbsp; &nbsp; &nbsp; - 详情[https://github.com/node-fetch/node-fetch](https://github.com/node-fetch/node-fetch)</div><div>&nbsp; - **resFn**(view: ExportBody, response: Response)</div><div>&nbsp; &nbsp; - **view**&nbsp; 格式化输出的参数 ExportBody中参数参照</div><div>&nbsp; &nbsp; - **res**&nbsp; &nbsp;详情请阅读node-fetch</div><div><br></div><div>`netFetch(url: string, para: any = {}, option: IFetchRequestInit = {}): Promise&lt;ExportBody&gt;`</div><div>- **url**&nbsp; &nbsp;请求的短路径或者全路径 例如：post.ts:ticket/outsearch 后端车次列表查询</div><div>&nbsp; - **ts**: 表示 http://train.17usoft.net/ticketsearch/api/ 的简写</div><div>&nbsp; - **post**:&nbsp; post 表示发送post请求</div><div>&nbsp; - **ticket/outsearch**： 表示后面的具体地址</div><div>- **para**&nbsp; 发送的参数，具体形式会根据请求接口而定</div><div>- **option** 详情请阅读node-fetch</div><div>- **return** `Promise&lt;ExportBody&gt;`</div><div><br></div><div>## 拦截器</div><div>`/serve/config/fetch/lib/`</div><div>- **fro** https://wx.17u.cn/frontstage/ 接口封装</div><div>- **nin1** 多站中检层接口封装，不同渠道不同的地址</div><div>- **supplier** 供应商提供的接口</div><div>- **ts**&nbsp; http://train.17usoft.net/ticketsearch/api/ 接口封装</div><div><br></div><div>## Graphql</div><div><br></div><div>- `/serve/config/gql` 配置gql</div><div>- `/serve/gql` 将gql映射到路由上</div><div><br></div><div>### Graphql访问参数</div><div>- **gql**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;graphql查询语句</div><div>- **type**=query&nbsp; &nbsp; &nbsp; graphql分类</div><div>- **para**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gql中对应的参数</div><div>- **commArg**&nbsp; &nbsp; &nbsp; &nbsp;默认的全局参数</div><div><br></div><div>### Graphql使用实例</div><div>- /serve/api/train/list</div><div><br></div><div>### 注意事项&nbsp;</div><div>由于Graphql是一个整体来运作，所有定义type是，尽量名字取的全一点，防止类型定义冲突</div><div><br></div><div>### API</div><div>`new GQLContral(type:string)`</div><div>- **type**=query 类型，不同类型的gql不能通用</div><div><br></div><div>`gqlContral.on(option: IResolverOption | string, exec: IExecFn, typeFns?: iTypeFns)`</div><div>- **option**:string 表示 gqlFn</div><div>- **option**:IResolverOption</div><div>&nbsp; - **gqlFn** 当前gql查询语句</div><div>&nbsp; - **type**&nbsp; gql的类型定义，一般用 importSchema 导入</div><div>- **exec**:(event: EventData) 路由执行函数</div><div>&nbsp; - **para** param.para json格式化对象</div><div>&nbsp; - **commArg** CommArg param.commArg 格式化对象</div><div>&nbsp; - **allPara** para&amp;CommArg</div><div>&nbsp; - **setErr**(code, msg)</div><div>&nbsp; &nbsp; - **code** 错误代码</div><div>&nbsp; &nbsp; - **msg** 错误信息</div><div><br></div><div>`new GQLErrs()` 一些异常错误代码处理&nbsp;&nbsp;</div><div>一般使用使用的时候，使用上面的 `setErr`</div><div><br></div><div>### 接口数字签名&nbsp;&nbsp;</div><div>- MD5(commArg + para + 秘钥)&nbsp;&nbsp;</div><div>- 秘钥在 /serve/config/sign 中配置</div></div><div><br></div>